<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Diagn√≥stico y Correcci√≥n Inmediata</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-box {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .error { border-left: 4px solid #f44336; }
        .success { border-left: 4px solid #4CAF50; }
        .warning { border-left: 4px solid #ff9800; }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #1976D2; }
        .console-log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üîß Diagn√≥stico de Sistema de Productos</h1>
    
    <div class="test-box warning">
        <h3>üìä Diagn√≥stico Autom√°tico</h3>
        <button onclick="ejecutarDiagnostico()">üîç Diagnosticar Problemas</button>
        <div id="diagnostico-resultados"></div>
    </div>
    
    <div class="test-box">
        <h3>üéØ Test 1: Funci√≥n subirProducto()</h3>
        <button onclick="testSubirProducto()">Probar Subir Producto</button>
        <div id="test1-resultado"></div>
    </div>
    
    <div class="test-box">
        <h3>üì∏ Test 2: Sistema de Im√°genes</h3>
        <button onclick="testSistemaImagenes()">Probar Sistema de Im√°genes</button>
        <div id="test2-resultado"></div>
    </div>
    
    <div class="test-box">
        <h3>‚úèÔ∏è Test 3: Funci√≥n Editar/Guardar</h3>
        <button onclick="testEditarGuardar()">Probar Editar y Guardar</button>
        <div id="test3-resultado"></div>
    </div>
    
    <div class="test-box">
        <h3>üìã Consola de Debug</h3>
        <div id="console" class="console-log"></div>
        <button onclick="limpiarConsola()">Limpiar Consola</button>
    </div>
    
    <div class="test-box success">
        <h3>üîß Correcci√≥n Autom√°tica</h3>
        <p>Si los tests fallan, haz clic aqu√≠ para aplicar correcciones autom√°ticas:</p>
        <button onclick="aplicarCorreccionCompleta()" style="background: #4CAF50; font-size: 16px; padding: 15px 25px;">
            üöÄ CORREGIR TODO AUTOM√ÅTICAMENTE
        </button>
    </div>
    
    <script src="script.js"></script>
    <script>
        // Override console.log para capturar mensajes
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function logToDiv(message, type = 'log') {
            const console = document.getElementById('console');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f44' : type === 'warn' ? '#fa0' : '#0f0';
            console.innerHTML += `<div style="color: ${color}">[${time}] ${message}</div>`;
            console.scrollTop = console.scrollHeight;
        }
        
        console.log = (msg) => { originalLog(msg); logToDiv(msg); };
        console.error = (msg) => { originalError(msg); logToDiv(msg, 'error'); };
        console.warn = (msg) => { originalWarn(msg); logToDiv(msg, 'warn'); };
        
        function limpiarConsola() {
            document.getElementById('console').innerHTML = '';
        }
        
        function ejecutarDiagnostico() {
            const resultados = document.getElementById('diagnostico-resultados');
            resultados.innerHTML = '<h4>Ejecutando diagn√≥stico...</h4>';
            
            const tests = [];
            
            // Test 1: Funci√≥n subirProducto existe
            if (typeof subirProducto === 'function') {
                tests.push('‚úÖ Funci√≥n subirProducto() existe');
            } else {
                tests.push('‚ùå Funci√≥n subirProducto() NO EXISTE');
            }
            
            // Test 2: Elementos HTML existen
            const campos = ['categoria-select', 'equipo-input', 'liga-select', 'precio-input', 'uploadZone'];
            campos.forEach(id => {
                if (document.getElementById(id)) {
                    tests.push(`‚úÖ Elemento ${id} existe`);
                } else {
                    tests.push(`‚ùå Elemento ${id} NO EXISTE`);
                }
            });
            
            // Test 3: Variable imagenesArray
            if (typeof imagenesArray !== 'undefined') {
                tests.push('‚úÖ Variable imagenesArray est√° definida');
            } else {
                tests.push('‚ùå Variable imagenesArray NO DEFINIDA');
            }
            
            // Test 4: localStorage
            if (typeof localStorage !== 'undefined') {
                tests.push('‚úÖ localStorage disponible');
            } else {
                tests.push('‚ùå localStorage NO disponible');
            }
            
            // Test 5: Productos object
            if (typeof productos === 'object' && productos !== null) {
                tests.push('‚úÖ Objeto productos existe');
            } else {
                tests.push('‚ùå Objeto productos NO EXISTE');
            }
            
            resultados.innerHTML = `
                <h4>Resultados del Diagn√≥stico:</h4>
                ${tests.map(test => `<div>${test}</div>`).join('')}
            `;
        }
        
        function testSubirProducto() {
            const resultado = document.getElementById('test1-resultado');
            resultado.innerHTML = '<p>Probando funci√≥n subirProducto()...</p>';
            
            try {
                // Simular datos del formulario
                console.log('üß™ Iniciando test de subirProducto()');
                
                if (typeof subirProducto === 'function') {
                    console.log('‚úÖ Funci√≥n subirProducto() encontrada');
                    resultado.innerHTML = '<p style="color: green">‚úÖ Funci√≥n subirProducto() est√° disponible</p>';
                } else {
                    console.error('‚ùå Funci√≥n subirProducto() NO EXISTE');
                    resultado.innerHTML = '<p style="color: red">‚ùå Funci√≥n subirProducto() NO EXISTE</p>';
                }
            } catch (error) {
                console.error('‚ùå Error en test:', error);
                resultado.innerHTML = `<p style="color: red">‚ùå Error: ${error.message}</p>`;
            }
        }
        
        function testSistemaImagenes() {
            const resultado = document.getElementById('test2-resultado');
            
            try {
                console.log('üß™ Probando sistema de im√°genes');
                
                if (typeof imagenesArray !== 'undefined') {
                    console.log('‚úÖ imagenesArray definida');
                    resultado.innerHTML = '<p style="color: green">‚úÖ Sistema de im√°genes b√°sico OK</p>';
                } else {
                    console.error('‚ùå imagenesArray no definida');
                    resultado.innerHTML = '<p style="color: red">‚ùå imagenesArray no est√° definida</p>';
                }
                
                if (typeof setupImageDragDrop === 'function') {
                    console.log('‚úÖ setupImageDragDrop() encontrada');
                } else {
                    console.error('‚ùå setupImageDragDrop() NO EXISTE');
                }
                
            } catch (error) {
                console.error('‚ùå Error en test de im√°genes:', error);
                resultado.innerHTML = `<p style="color: red">‚ùå Error: ${error.message}</p>`;
            }
        }
        
        function testEditarGuardar() {
            const resultado = document.getElementById('test3-resultado');
            
            try {
                console.log('üß™ Probando funci√≥n de editar/guardar');
                
                if (typeof window.guardarCambiosProducto === 'function') {
                    console.log('‚úÖ guardarCambiosProducto() encontrada');
                    resultado.innerHTML = '<p style="color: green">‚úÖ Funci√≥n guardarCambiosProducto() disponible</p>';
                } else {
                    console.error('‚ùå guardarCambiosProducto() NO EXISTE');
                    resultado.innerHTML = '<p style="color: red">‚ùå Funci√≥n guardarCambiosProducto() NO EXISTE</p>';
                }
                
            } catch (error) {
                console.error('‚ùå Error en test de edici√≥n:', error);
                resultado.innerHTML = `<p style="color: red">‚ùå Error: ${error.message}</p>`;
            }
        }
        
        function aplicarCorreccionCompleta() {
            console.log('üöÄ APLICANDO CORRECCI√ìN COMPLETA...');
            
            // Redefinir imagenesArray globalmente
            window.imagenesArray = [];
            
            // Redefinir funci√≥n obtenerImagenesOrdenadas
            window.obtenerImagenesOrdenadas = function() {
                if (typeof window.imagenesArray !== 'undefined' && window.imagenesArray.length > 0) {
                    return window.imagenesArray.map(img => img.src);
                }
                return [];
            };
            
            // Funci√≥n subirProducto corregida
            window.subirProducto = function() {
                console.log('üöÄ Iniciando subida de producto [CORREGIDO]...');
                
                const categoria = document.getElementById('categoria-select')?.value || 'camisetas';
                const equipo = document.getElementById('equipo-input')?.value?.trim() || '';
                const liga = document.getElementById('liga-select')?.value || 'laliga1';
                const precioInput = document.getElementById('precio-input')?.value?.trim() || '';
                
                console.log('üìù Datos del formulario:', { categoria, equipo, liga, precioInput });
                
                if (!equipo || !precioInput) {
                    alert('Por favor, completa todos los campos obligatorios');
                    return;
                }
                
                const precio = parseFloat(precioInput);
                if (isNaN(precio) || precio <= 0) {
                    alert('Por favor, ingresa un precio v√°lido');
                    return;
                }
                
                const imagenesOrdenadas = window.obtenerImagenesOrdenadas();
                console.log('üì∏ Im√°genes obtenidas:', imagenesOrdenadas.length);
                
                const nuevoProducto = {
                    id: Date.now(),
                    nombre: equipo,
                    precio: precio,
                    liga: liga,
                    imagen: imagenesOrdenadas.length > 0 ? imagenesOrdenadas[0] : null,
                    imagenes: imagenesOrdenadas,
                    categoria: categoria,
                    fechaCreacion: new Date()
                };
                
                // Asegurar que existe el array de la categor√≠a
                if (!window.productos[categoria]) {
                    window.productos[categoria] = [];
                }
                
                window.productos[categoria].push(nuevoProducto);
                console.log('‚úÖ Producto a√±adido a la categor√≠a:', categoria);
                
                // Guardar
                if (typeof guardarDatos === 'function') {
                    guardarDatos();
                }
                
                // Limpiar formulario
                const equipoInput = document.getElementById('equipo-input');
                const precioInputEl = document.getElementById('precio-input');
                if (equipoInput) equipoInput.value = '';
                if (precioInputEl) precioInputEl.value = '';
                
                // Resetear im√°genes
                window.imagenesArray = [];
                const uploadZone = document.getElementById('uploadZone');
                const previewContainer = document.getElementById('imagenesPreview');
                if (previewContainer) {
                    previewContainer.remove();
                }
                if (uploadZone) {
                    uploadZone.innerHTML = `
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Arrastra im√°genes aqu√≠ o haz clic para seleccionar</p>
                    `;
                }
                
                // Mostrar modal de √©xito
                mostrarModalExitoSimple();
                
                console.log('üéâ ¬°Producto subido exitosamente!');
            };
            
            // Funci√≥n mostrarModalExitoSimple
            window.mostrarModalExitoSimple = function() {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.7);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;
                
                modal.innerHTML = `
                    <div style="
                        background: white;
                        border-radius: 15px;
                        padding: 40px;
                        text-align: center;
                        max-width: 400px;
                    ">
                        <div style="
                            background: #4CAF50;
                            color: white;
                            border-radius: 50%;
                            width: 80px;
                            height: 80px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin: 0 auto 20px;
                            font-size: 40px;
                        ">‚úì</div>
                        
                        <h2 style="color: #333; margin: 0 0 15px 0;">¬°Producto Subido!</h2>
                        <p style="color: #666; margin: 0 0 25px 0;">Tu producto ha sido a√±adido exitosamente al cat√°logo.</p>
                        
                        <button onclick="this.closest('div').parentNode.remove()" style="
                            background: #4CAF50;
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            cursor: pointer;
                        ">Perfecto</button>
                    </div>
                `;
                
                document.body.appendChild(modal);
            };
            
            console.log('üéâ ¬°CORRECCI√ìN APLICADA! Ahora prueba subir un producto.');
            alert('‚úÖ Correcci√≥n aplicada exitosamente! Ahora ve al Admin y prueba subir un producto.');
        }
    </script>
</body>
</html>